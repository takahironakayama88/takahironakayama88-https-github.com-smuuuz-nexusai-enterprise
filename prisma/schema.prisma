// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// çµ„ç¹”ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ã‚·ãƒ¼ã®åŸºæœ¬å˜ä½ï¼‰
model Organization {
  id                  String   @id @default(cuid())
  name                String
  encOpenaiKey        String?  @map("enc_openai_key")  // AES-256-GCMæš—å·åŒ–
  encAnthropicKey     String?  @map("enc_anthropic_key")
  encGoogleKey        String?  @map("enc_google_key")
  tokenMonthlyLimit   Int      @default(1000000) @map("token_monthly_limit")
  currentUsage        Int      @default(0) @map("current_usage")

  // AIãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆå„ãƒ¢ãƒ¼ãƒ‰ã«ç´ã¥ããƒ¢ãƒ‡ãƒ«IDï¼‰
  fastModeModel       String?  @map("fast_mode_model")      // é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰
  balancedModeModel   String?  @map("balanced_mode_model")  // ãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰
  precisionModeModel  String?  @map("precision_mode_model") // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰
  settingsMode        String   @default("simple") @map("settings_mode") // simple or custom

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  users               User[]
  threads             Thread[]
  assistants          Assistant[]
  assistantCategories AssistantCategory[]
  auditLogs           AuditLog[]

  @@map("organizations")
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼
model User {
  id             String       @id @default(cuid())
  email          String       @unique
  passwordHash   String       @map("password_hash")
  role           UserRole     @default(MEMBER)
  organizationId String       @map("organization_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  threads            Thread[]
  createdAssistants  Assistant[]  @relation("AssistantCreator")
  auditLogs          AuditLog[]

  @@map("users")
}

enum UserRole {
  OWNER
  MEMBER
}

// ãƒãƒ£ãƒƒãƒˆã‚¹ãƒ¬ãƒƒãƒ‰
model Thread {
  id             String       @id @default(cuid())
  title          String       @default("New Chat")
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  assistantId    String?      @map("assistant_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assistant      Assistant?   @relation(fields: [assistantId], references: [id], onDelete: SetNull)
  messages       Message[]

  @@map("threads")
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
model Message {
  id            String   @id @default(cuid())
  threadId      String   @map("thread_id")
  role          MessageRole
  content       String
  modelId       String   @map("model_id")  // "gpt-4", "claude-3-5-sonnet", etc.
  tokensUsed    Int      @default(0) @map("tokens_used")
  costEstimate  Float    @default(0) @map("cost_estimate")  // USD
  createdAt     DateTime @default(now()) @map("created_at")

  thread        Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@map("messages")
}

enum MessageRole {
  user
  assistant
  system
}

// ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚«ãƒ†ã‚´ãƒªï¼ˆçµ„ç¹”å˜ä½ï¼‰
model AssistantCategory {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  name           String
  displayOrder   Int      @default(0) @map("display_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assistants     Assistant[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("assistant_categories")
}

// ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
model Assistant {
  id                String       @id @default(cuid())
  organizationId    String       @map("organization_id")
  categoryId        String?      @map("category_id")
  name              String
  description       String       @default("")
  iconEmoji         String       @default("ğŸ¤–") @map("icon_emoji")
  iconColor         String       @default("indigo") @map("icon_color") // indigo, purple, blue, green, orange, pink, red
  systemPrompt      String       @map("system_prompt")
  modelId           String?      @map("model_id")  // null = ãƒ¢ãƒ¼ãƒ‰è¨­å®šã«å¾“ã†
  conversationStarters String    @default("[]") @map("conversation_starters") // JSONé…åˆ—
  visibility        String       @default("all") // all, owner_only
  isActive          Boolean      @default(true) @map("is_active")
  createdBy         String       @map("created_by")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category          AssistantCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  creator           User         @relation("AssistantCreator", fields: [createdBy], references: [id])
  threads           Thread[]

  @@index([organizationId])
  @@map("assistants")
}

// ç›£æŸ»ãƒ­ã‚°
model AuditLog {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  action         String   // login, api_key_change, mode_change, thread_create, thread_delete
  metadata       String   @default("{}")  // JSONæ–‡å­—åˆ—ï¼ˆSQLiteã«ã¯JSONå‹ãŒãªã„ãŸã‚ï¼‰
  ipAddress      String?  @map("ip_address")
  createdAt      DateTime @default(now()) @map("created_at")

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}
