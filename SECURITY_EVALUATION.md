# Azure SaaS展開 総合セキュリティ評価レポート

**評価日**: 2026-02-05
**対象**: SunSun
**運用モデル**: BYOK（顧客がAPIキーを持ち込む方式）

---

## 1. 現状のアプリケーションセキュリティ評価

| カテゴリ | 現状 | リスクレベル | 対応優先度 |
|---------|------|-------------|-----------|
| パスワードハッシュ | SHA-256（脆弱） | Critical | P0 |
| JWTシークレット | ハードコードフォールバック | Critical | P0 |
| レート制限 | 未実装 | High | P1 |
| APIキー暗号化 | AES-256-GCM | Good | - |
| マルチテナント分離 | Prisma経由で実装 | Good | - |
| RBAC | OWNER/ADMIN/MEMBER | Good | - |
| 監査ログ | 実装済み | Good | - |

---

## 2. BYOK（顧客APIキー管理）セキュリティ評価

### 現在の実装フロー
```
顧客 → APIキー入力 → AES-256-GCM暗号化 → DB保存 → 復号 → LLMプロバイダー
```

### 強み
- **暗号化**: AES-256-GCMは業界標準
- **責任分離**: LLMコストは顧客負担、料金トラブル回避
- **柔軟性**: 顧客が好みのプロバイダー/プランを選択可能

### 改善が必要な点

| 項目 | 現状 | 推奨対応 |
|------|------|---------|
| 暗号化キー管理 | 環境変数 | Azure Key Vault |
| キー派生関数 | 直接使用 | PBKDF2/HKDF導入 |
| キー検証 | なし | 保存前にAPI疎通確認 |
| キーローテーション | 未対応 | 顧客向けUI追加 |
| アクセスログ | 基本的 | 詳細な使用履歴追加 |

---

## 3. Azure移行前に必須の修正項目

### P0（デプロイ前に必須）

#### パスワードハッシュの強化
```typescript
// 現状（危険）
crypto.createHash('sha256').update(password).digest('hex')

// 推奨（bcrypt or Argon2）
import bcrypt from 'bcrypt';
await bcrypt.hash(password, 12);
```

#### JWT シークレットの環境変数必須化
```typescript
// 現状
const JWT_SECRET = process.env.JWT_SECRET || 'dev-jwt-secret...';

// 推奨（フォールバックなし）
const JWT_SECRET = process.env.JWT_SECRET;
if (!JWT_SECRET) throw new Error('JWT_SECRET is required');
```

#### 暗号化キーをKey Vaultへ移行
```
ENCRYPTION_KEY: 環境変数 → Azure Key Vault
JWT_SECRET: 環境変数 → Azure Key Vault
```

### P1（本番運用前に必須）

| 項目 | 実装内容 |
|------|---------|
| レート制限 | Azure API Management or アプリ内実装 |
| WAF | Azure Front Door + WAF Policy |
| CORS設定 | 本番ドメインのみ許可 |
| CSP | Content-Security-Policy ヘッダー |
| HTTPS強制 | Azure App Service標準 |

---

## 4. Azure環境でのセキュリティ構成（推奨）

```
┌─────────────────────────────────────────────────────────────┐
│                    Azure Front Door                         │
│            (WAF, DDoS Protection, CDN)                     │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTPS only
┌─────────────────────▼───────────────────────────────────────┐
│              Azure App Service (Next.js)                    │
│   - VNet統合                                                │
│   - マネージドID (Key Vault認証)                            │
│   - 環境変数はKey Vault参照                                  │
└─────────────────────┬───────────────────────────────────────┘
                      │ Private Endpoint
┌─────────────────────▼───────────────────────────────────────┐
│         Azure Database for PostgreSQL                       │
│   - VNet内でのみアクセス可能                                 │
│   - SSL/TLS必須                                             │
│   - 自動バックアップ + PITR                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Azure Key Vault                                │
│   - ENCRYPTION_KEY                                          │
│   - JWT_SECRET                                              │
│   - DB接続文字列                                             │
│   - アクセスログ完備                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. SaaS提供時のコンプライアンス対応

| 要件 | Azure対応 | 追加実装 |
|------|----------|---------|
| **データ所在地** | Japan Eastリージョン | リージョン固定設定 |
| **GDPR/個人情報** | Azure標準 | データ削除API実装 |
| **監査ログ** | 実装済み | 保持期間設定 |
| **SLA** | Azure 99.95% | 顧客向けSLA文書 |
| **インシデント対応** | Azure Security Center | 通知フロー構築 |

---

## 6. BYOK特有のセキュリティリスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| **顧客キー漏洩** | 顧客のLLM費用発生 | 暗号化 + アクセスログ + 通知 |
| **不正利用検知** | サービス信頼低下 | 使用量モニタリング + アラート |
| **キー失効** | 機能停止 | エラーハンドリング + 通知 |
| **プロバイダー障害** | サービス停止 | マルチプロバイダー対応（実装済み） |

---

## 7. 総合評価サマリー

| 評価項目 | 現状スコア | Azure移行後予測 |
|----------|-----------|-----------------|
| 認証・認可 | 2/5 | 4/5 |
| データ保護 | 3/5 | 5/5 |
| ネットワーク | 2/5 | 5/5 |
| 監査・ログ | 4/5 | 5/5 |
| BYOK安全性 | 3/5 | 4/5 |
| **総合** | **60点** | **85点** |

---

## 8. 推奨アクションプラン

### Phase 1: 必須修正（Azure移行前）
- [ ] bcrypt導入（パスワードハッシュ）
- [ ] JWT_SECRET フォールバック削除
- [ ] レート制限実装

### Phase 2: Azure基盤構築
- [ ] App Service + VNet統合
- [ ] PostgreSQL + Private Endpoint
- [ ] Key Vault設定
- [ ] Front Door + WAF

### Phase 3: 運用準備
- [ ] 監視・アラート設定
- [ ] バックアップ・DR計画
- [ ] セキュリティテスト
- [ ] コンプライアンス文書

---

## 9. コスト見積もり

| 構成 | 月額コスト |
|------|-----------|
| 最小構成 | ~¥6,800/月 |
| 推奨構成 | ~¥52,000/月 |
| スケールアップ | ~¥140,000/月 |

---

## 結論

現状はPoC/MVP段階のセキュリティレベル。SaaS本番運用にはP0項目の修正が必須だが、Azure移行と合わせて対応すれば企業向けSaaSとして十分なセキュリティレベルを達成可能。

BYOKモデルは責任分界が明確で、適切な暗号化とKey Vault管理により安全に運用可能。

---

*最終更新: 2026-02-05*
